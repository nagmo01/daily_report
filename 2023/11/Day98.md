# 2023/11/30の日報


## 取り組んだこと
- EC課題
- heroku時にattachできない問題の調査

## わかったこと

- herokuでデプロイ時に画像ファイルを用意しておいて、local:の設定でFile.openでパス指定でattachは無理っぽい
- herokuでS3に保存しておいた画像ファイルをseeds.rbなどでそのままattachも無理っぽい
- active_storageでattachするときはローカルにファイルが一時的にないとできないっぽい。つまりクラウドにある画像をattachは難しい。


## 次やること
- 実装を前倒しでフォームを作成してみて、フォームからアプリに画像ファイルを送ったときにうまくattachしてくれるかを確認する。

 
## 感じたこと
- うまくいかない状態が長引くと原因の推測が曖昧になりがちなので問題の切り分けをうまく行っていく必要があると感じた。
- 特にダレてたわけでもないのに11月入って1PRも出せなかった。
- 一つ解決すると次の項目で数日ハマるというのを繰り返していてここにきてプログラミングの難しさを実感中。
 

## 学習時間
- TODAY: 5h
- TOTAL: 442h 



# プログラミング学習

### accessキー、環境変数

storage.ymlに直でキーを書いてしまうとgithubにpushするだけで流出してしまう。(publicなら)

storage.ymlには環境変数を入れておいて、
↓こんな感じ
```
amazon: 
  service: S3 
  access_key_id: <%= ENV['AWS_ACCESS_KEY'] %> 
  secret_access_key: <%= ENV['AWS_SECRET_KEY'] %> 
  region: <%= ENV['AWS_REGION'] %> 
  bucket: <%= ENV['AWS_BUCKET'] %>
```

以下の方法でキーを設定する。

##### ①直接コマンドで定義する
``$ heroku config:set AWS_ACCESS_KEY="accessキー"``のようにherokuに直接コマンドを打つ。

##### ②ファイルに記述する
``gem 'dotenv-rails'``を入れて``.env``ファイルを作成してその中に
```
access_key_id: <%= ENV['AWS_ACCESS_KEY'] %> 
secret_access_key: <%= ENV['AWS_SECRET_KEY'] %>
```
のように記述して読み込ませる。
このままだと単純に隠れファイルとして.envがgit pushされてしまうので
``.gitignore``に/.envを記述してコミット対象から除く


①だとローカルと本番環境等で別々で打たなければいけないが、②の方だと環境が変わっても使えるのでいいかも。



### gem 'aws-sdk-s3'の使い方

https://mogulla3.tech/articles/2019-12-07-01/

AWS s3の公式ruby gem。  
S3とrailsのやりとりを簡単に行えるようにしてくれる。  
awsの操作をrubyのコードでできるようにするためのgem.


``gem 'aws-sdk-s3' require: false``

require: falseを指定すると勝手にインストールされなくなるため、使いたい場面が特定のスクリプトのみの場合などにこうしておいて、requireをして使うというやり方をする。





### active_storageでクラウドストレージ(S3)を利用してファイルを保存する流れ

1. ファイルをアップロード 
2. active_storageの介入
3. ファイルの転送
4. ファイルのattach

#### 1. ファイルをアップロード
ユーザーがアプリケーションにファイルをアップロードします。<%= form_%>とかのイメージ
このときにファイルはまずアプリケーションのサーバーに送信される。要はrailsのサーバー

#### 2. Active_storageの介入
railsサーバーはアップロードされてきたファイルをactive_storageに渡す。
active_storageはファイルのメタデータ(name,content-type,byte-sizeなど)をデータベースに保存する。このメタデータがActiveStorage::Blobオブジェクトとして保管される。

#### 3. ファイルの転送
その後にactive_storageはアップロードされたファイルをクラウドストレージに送る。
送られたファイルがクラウドストレージのバケットに保存され、一意のキー（ AWS側から的なことだと思う）が割り当てられる。このキーがActiveStorage::Blobオブジェクトに保存される。あとで保存したファイルを参照するときにこのキーが使われる。

#### 4. ファイルのattach
最後にアプリケーションがActiveStorage::Blobオブジェクトを特定のレコード（例えばuser）にattachする。これによりuserレコードはS3に保存されたファイルを参照することができるようになる。


### 追加情報

- active_storageがファイルをattachする際にそのファイルがローカルに存在している必要がある。なのでS3のパス？を指定するような形でattachするみたいな方法はできない。

- もしやるとしたら、一回S3からローカルに一時ダウンロードする。それをattachする。

- 設置したフォームなどからファイルがアップロードされる実際の運用でありそうな状況の場合は、まずactive_storageがアップロードされてきたファイルを受け取り、blobやattach、S3へのアップロードをする。このときに一時的にローカルにファイルがある状態になるのでこちらの場合はattach可能。


### 思ったこと
active_storageを使って特定のレコードに画像をattachさせたいときに、多分だが一時的にローカルにファイルが存在する必要があるため、S３にもともと用意しておいたファイルをlocal:の時と同じようにattachしようとしてもできない気がする。するとしたら一回、ローカルにS3からダウンロードする。それをattachしないといけないぽい。なのでattachの記述自体は落としたローカルのパスを書くことになるのでlocal:時とそんなに変わらない。



### 状況整理
- S3の登録やbucketの作成。できてる。
- railsとS3の接続　多分できてるとは思うが確認方法がわからない。
- active_storageとS3のデータのやり取り。具体的にいうとS3のバケットの中にある画像をitemレコードにattachしたい。　これは確実にできていない。というかそもそもできるのか怪しい。



### 試そうと思っていること。
実際のサイト運用のような感じで<%= form %>のような形でフォームを設置してそれで渡してみる。そこでうまくいけば、active_storageの特性上seeds.rbに用意できないだけという解釈で大丈夫そう。



### chatGPTに聞いたことメモ

1.
追加で質問です。S3に自身で用意した画像をseeds.rbでattachさせて使うためには一時的にS3から使うためにダウンロードが必要とのことでした。つまりローカル上に画像がある状態にしないといけないという意味だと思います。ユーザー側からアップロードされたファイルはその必要なくattachできたかと思いますが違いますか？

```
はい、その通りです。ユーザーがアップロードしたファイルは、そのファイルがすでにローカルに存在しているため、Active Storageに直接attachすることができます。しかし、S3などのクラウドストレージに保存されているファイルをattachする場合、そのファイルを一時的にローカルにダウンロードする必要があります。

これは、Active Storageがファイルをattachする際には、そのファイルがローカルに存在している必要があるからです。そのため、S3から直接ファイルをattachすることはできません。その代わりに、S3からファイルを一時的にダウンロードして、そのダウンロードしたファイルをActive Storageにattachします。

ただし、この方法ではS3から直接ファイルを読み込むため、S3の認証情報が必要になります。また、大量のファイルを扱う場合は、パフォーマンスに影響を及ぼす可能性がありますので、注意が必要です。
```


2.
ユーザー側からアップロードされたファイルがattachする流れについて教えてください。 attachする時はローカル上にファイルが存在する必要があるということですが、blobオブジェクトにメタデータを格納するときに必要という意味ですか？それともレコードにblobオブジェクトをアタッチするときに必要という意味ですか？

```
ユーザーがファイルをアップロードするとき、そのファイルはまずウェブサーバーに送信され、
次にActive Storageによって指定されたストレージサービス（例えば、Amazon S3）に保存されます

このプロセスは以下のように行われます：

1. ユーザーがファイルを選択し、フォームを送信します。
2. フォームのデータ（ファイルを含む）がウェブサーバーに送信されます。
3. [サーバー側のコード（通常はRailsコントローラー）が、送信されたファイルを取得し、
Active Storageの`attach`メソッドを使用してそれをActive Recordオブジェクト（例えば、Userモデルのインスタンス）に添付します

# コントローラー内
@user.avatar.attach(params[:avatar])

4. `attach`メソッドは、ファイルのメタデータ（ファイル名、コンテンツタイプ、サイズなど）をデータベースに保存する新しいActive Storage `Blob`を作成します

5. 次に、`attach`メソッドはファイル自体をストレージサービスにアップロードします
このとき、ファイルは一時的にウェブサーバーのローカルストレージに保存されます。

6. 最後に、
`attach`メソッドはActive Recordオブジェクトと新しく作成した`Blob`を関連付けます
これにより、Active Recordオブジェクトを通じてファイルにアクセスできるようになります。

したがって、ファイルがローカルに存在する必要があるというのは、`attach`メソッドがファイルをストレージサービスにアップロードするとき、そして`Blob`がファイルのメタデータをデータベースに保存するときのことを指します
```


3.
一時的にローカルストレージに保存されたファイルはその後削除されるのですか？また削除される場合のタイミングを教えてください。またそのファイルは保存されるパスを教えてください。

```
[はい、Active Storageがファイルをストレージサービスにアップロードする際には、そのファイルは一時的にウェブサーバーのローカルストレージに保存されます
この一時ファイルは、ファイルがストレージサービスにアップロードされた後に削除されます]

具体的には、Active Storageはファイルをダウンロードして一時ファイルを作成し、その一時ファイルをディスクに書き込みますそして、ファイルがディスクに書き込まれた後、`ensure`ブロック内で`file.close!`が呼び出されます

この`close!`メソッドは、ファイルを閉じてディスクからすぐに削除します

[一時ファイルの保存場所は、Rubyの`Tempfile`クラスが管理しています。

`Tempfile`クラスは、一時ファイルをシステムの一時ディレクトリ（通常は`/tmp`または`C:\Windows\Temp`）に作成します

ただし、このパスは環境変数によって変更することができます]
```




### attachできる、できない　まとめ

実際の運用でユーザーからrailsサーバーにアップロードされた時は、
サーバーがattachした後にクラウドストレージに送るので、attachできる。

seeds.rbなどですでにS3にある画像をレコードにattachしようとするのは、
サーバーにファイルがないのでattachできない。


#プログラミング言語/Rails 
#active_storage 
#heroku 
#S3 
#環境変数
