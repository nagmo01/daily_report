# 2023/12/27の日報


## 取り組んだこと
- チェックアウト機能の実装

## わかったこと
- 電話番号くらいの桁数になるとintegerは使えないのでbigintまたはstringなどにする必要がある。
- 購入明細は管理者側でのみ確認できる仕様にする


## 感じたこと
- validateにnot null制約的なものを書いたけど多分こっちじゃなくて普通にテーブルに定義した方が良かった。
- 



## 次やること
- validateエラーになったときのエラーメッセージをうまいこと入力欄に表示させる。

- 
## 学習時間
- TODAY: 4h
- TOTAL: 533h



## 今日の学習メモ
- ~~PRきてたらマージしてブランチ切るor修正あれば対応~~
- ~~モデル作成(payment)~~
- ~~テーブル作成（migrate)~~
- ~~コントローラ作成(Payment)~~
- viewファイルを調整


### チェックアウト機能について
![[スクリーンショット 2023-12-25 13.24.28.png]]
pref,cityにカラム名を変更した
カートテーブルの外部キーを持つ必要性がなかったのでなしにした

Paymentモデルを作成する
``rails g model Payment``


Controllerは新しく
``rails g controller Payments``
payments_controller.rbを作成する。
コントローラ名、モデル名、テーブル名は基本的に一致させることが推奨されているっぽい。
設定より規約　より。


#### モデル名とコントローラ名が異なる場合、
**いくつか自動化されている機能が利用できなくなる。**
- ルーティング　resourcesやitems_pathのような記述が使えなくなる。
- ビューの探索　コントローラのアクションの最後で基本的にコントローラと同名のビューを返すがこれがなくなるので手動でビューを指定する必要がでる
- ストロングパラメータ　モデル名でグループ化してくれていたので手動で許可する必要がある。
- フォームヘルパー　form_withなどの指定にmodelを使えなくなるので "/items/#{item.id}"のように手動で指定する必要がある。

適切に対応すればなんとかなりそうだけどここまでして命名を分ける必要性はなさそう。


rails g model Payment
rails g controller Payments create

実際に管理者ページでは全ての決済idが並んでる状態にして、さらに詳細を押すと
それぞれの決済ごとの購入された商品が一覧として表示できるようにしたい。
そちらは管理者のみのページなのでコントローラは
admin/payments_controller.rbのように別ディレクトリの方にする。


### form_withの使い方
https://pikawaka.com/rails/form_with
↑わかりやすい。form_with自体二つの用途を両立できるものになっているので使い方が割と複雑。

f.label :name "dadada"はラベルの名前 :nameの部分はform_withに渡すモデルに存在するカラム名にする。
f.text_field :name に入力欄を作る。labelと同じ命名にする。


- formの各項目はすべてデータベースに保存できるようにする
- 購入処理(DBに登録）が行われるようにする
- 購入後は`購入ありがとうございます`というflashメッセージとともに一覧画面に遷移するこ
#### 購入後は`購入ありがとうございます`というflashメッセージとともに一覧画面に遷移すること
```
flash[:success] = "購入ありがとうございます"
redirect_to items_path
```

### payments
| id | first_name | last_name | user_name | email | address | address2 |
| ---- | ---- | ---- | ---- | ---- | ---- | ---- |


ちょっと要件定義的にpaymentsテーブルにcart_idを持たせる必要があまりない気がしてきたのでなしで作ってみる。
「チェックアウト後すぐにカートを消す」からcart_idを保持しておく必要性がない気がする。
カートではなく、カート内の商品を消すなら割とcart_idをユーザーのような扱いとして使ってるので外部キーがあった方が購入履歴などの実装も多少できそうだけど。

#### 全然関係ないけど
マイグレーションの実行は一方通行になっており、マイグレーションファイルを修正して再度`rails db:migrate`しても更新されない。


## テーブルのデータ型の指定とモデルのvalidateについて

**俺の疑問**
テーブルでデータ型を指定しているのにわざわざvalidateでnumericality: trueのようなことを書く必要があるのか？

判断するタイミングが違うため、うまく二つを使うとアプリの堅牢性が向上するらしい。

ただ、基本的にはテーブルのデータ型で十分っぽい。

### 現状実装している部分
- 購入するを押したときにpaymentコントローラのcreateアクションに行く。
- アクション内でビューで入力したparamsをストロングパラメータを利用して、paymentモデルインスタンスを作成して代入。
- DBに保存を実行し、うまくいった場合商品一覧に戻る。(redirect_to)
- 失敗した場合、入力した内容は保持したままカートページに戻す。(render)

### まだな部分
~~- 実際に入力欄をモデルを利用して記述する。~~
~~- routesで"payments#create"を定義する。~~ いったん'/payment'で実装した。
REST的にはよくなさそう。

購入明細部分についてはまだ。（メールやカート内商品を別テーブルに移す、カート削除などなど）



 **電話番号あたりの桁数からは基本integerではなく、bigintまたはstringがいい**
 


 
